<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard</title>
<link rel="stylesheet" href="/assets/styles.css">
</head><body onload="init()">
<div class="header">
  <div class="brand">
    <img class="brand-logo" style="height:24px">
    <div class="brand-title">File Management</div>
  </div>
  <div class="right">
    <a href="/upload" class="btn blue">Upload</a>
    <button onclick="signOut()">Sign Out</button>
  </div>
</div>
<div class="container">
  <div class="card">
    <div class="actions">
      <div>
        <button id="rmSelected" class="btn red" disabled onclick="removeSelected()">Remove Selected</button>
      </div>
      <div class="top-right">
        <div class="search-wrap">
          <input id="q" type="text" placeholder="Search name or comments">
          <button class="btn" onclick="render()">Search</button>
        </div>
      </div>
    </div>
    <table class="table">
      <thead><tr><th style="width:40px">Select</th><th>File</th><th style="width:120px">Size</th><th style="width:260px">Action</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>
<div class="footer">Powered by ChatGPT â€¢ Â© iAmSaugata</div>
<div class="toast"></div>
<script src="/assets/common.js"></script>
<script>
let allFiles = []; let selected = new Set();

async function init(){ await loadBrand(); await fetchFiles(); render(); }
async function fetchFiles(){
  const r = await fetch('/api/files'); const j = await r.json(); allFiles = j.files;
}
function signOut(){ fetch('/logout',{method:'POST'}).then(()=>{ localStorage.removeItem('authed'); location.href='/login'; }); }
function toggle(id, el){ if(el.checked) selected.add(id); else selected.delete(id); document.getElementById('rmSelected').disabled = selected.size===0; }

function matches(f,q){
  q=q.trim().toLowerCase();
  if(!q) return true;
  return (f.original_name.toLowerCase().includes(q) || (f.comments||'').toLowerCase().includes(q));
}

function nameCell(f){
  const full = f.original_name;
  const needsEllipsis = full.length>30;
  const safe = needsEllipsis ? full.slice(0,30) : full;
  let html = `<div><span class="name-ellipsis">${safe}</span>`;
  if(needsEllipsis){ html += `<span class="ellipsis-mark tooltip" data-tip="${full}">â€¦</span>`; }
  if(f.comments){ html += ` <span class="tooltip" data-tip="${f.comments}">ðŸ“œ</span>`; }
  html += `</div><div class="small">${new Date(f.uploaded_at).toLocaleString()}</div>`;
  return html;
}

function row(f){
  return `<tr class="row">
    <td><input type="checkbox" onchange="toggle(${f.id}, this)"></td>
    <td>${nameCell(f)}</td>
    <td>${fmtBytes(f.size)}</td>
    <td>
      <button class="btn" onclick="getLink(${f.id})">GetLink</button>
      <button class="btn red" onclick="deleteOne(${f.id})">Delete</button>
    </td>
  </tr>`;
}

function render(){
  const q = document.getElementById('q').value||'';
  const list = allFiles.filter(f=>matches(f,q));
  const tb = document.getElementById('tbody'); tb.innerHTML = list.map(row).join('');
}

async function getLink(id){
  try{
    const {directUrl, pageUrl} = await post('/api/getlink', { id });
    await navigator.clipboard.writeText(directUrl);
    toast('Direct link copied','success');
  }catch(e){ toast('Failed to get link','error'); }
}

async function deleteOne(id){
  if(!confirm('Delete this file?')){ toast('Cancelled','info'); return; }
  try{
    await post('/api/delete',{ id });
    toast('Deleted','error');
    await fetchFiles(); render();
  }catch(e){ toast('Delete failed','error'); }
}

async function removeSelected(){
  if(selected.size===0) return;
  if(!confirm('Delete selected files?')){ toast('Cancelled','info'); return; }
  try{
    await post('/api/delete',{ ids: Array.from(selected) });
    selected.clear(); document.getElementById('rmSelected').disabled=true;
    toast('Deleted selected','error');
    await fetchFiles(); render();
  }catch(e){ toast('Bulk delete failed','error'); }
}
</script>
</body></html>
