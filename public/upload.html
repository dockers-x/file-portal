<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Upload</title>
<link rel="stylesheet" href="/assets/styles.css">
</head><body onload="initUpload()">
<div class="header">
  <div class="brand">
    <img class="brand-logo" style="height:24px">
    <div class="brand-title">File Management</div>
  </div>
  <div class="right">
    <button class="btn" onclick="goDash()">Done</button>
    <button id="cancelBtn" class="btn" disabled onclick="cancelUpload()">Cancel</button>
    <button class="btn red" onclick="signOut()">Sign Out</button>
  </div>
</div>
<div class="container">
  <div class="card">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div>
        <div id="drop" class="dropzone">Drag & Drop files here<br><br>
          <label class="btn blue"><input id="file" type="file" multiple style="display:none">Browse</label>
        </div>
        <div style="margin-top:10px">
          <label>Comments</label>
          <textarea id="comments" rows="4" placeholder="Optional comments"></textarea>
        </div>
      </div>
      <div>
        <div class="queue" id="queue"></div>
      </div>
    </div>
  </div>
</div>
<div class="footer">Powered by ChatGPT • © iAmSaugata</div>
<div class="toast"></div>
<script src="/assets/common.js"></script>
<script>
let controller=null;

function goDash(){ location.href='/dashboard'; }

function signOut(){ fetch('/logout',{method:'POST'}).then(()=>{ localStorage.removeItem('authed'); location.href='/login'; }); }

function initUpload(){
  loadBrand();
  const dz = document.getElementById('drop');
  const file = document.getElementById('file');
  dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.style.background='#eef2ff'; });
  dz.addEventListener('dragleave', e=>{ dz.style.background=''; });
  dz.addEventListener('drop', e=>{ e.preventDefault(); dz.style.background=''; handleFiles(e.dataTransfer.files); });
  file.addEventListener('change', e=> handleFiles(e.target.files));
}

async function sha256(file){
  return new Promise((resolve, reject)=>{
    const w = new Worker('/assets/sha-worker.js');
    w.onmessage = (ev)=>{ resolve(ev.data); w.terminate(); };
    w.onerror = (e)=>{ reject(e); w.terminate(); };
    w.postMessage({ file });
  });
}

function makeRow(name, size){
  const div = document.createElement('div'); div.className='row-queue';
  div.innerHTML = `<div><strong>${name}</strong> <span class="small">${fmtBytes(size)}</span></div>
  <div class="progress"><div></div></div>
  <div class="small muted" data-speed>Waiting…</div>
  <div class="small"><a data-link style="display:none" href="#" target="_blank">Open</a> <button data-copy class="btn" style="display:none">Copy Link</button></div>`;
  return div;
}

async function handleFiles(list){
  const files = [...list];
  const q = document.getElementById('queue');
  for(const f of files){
    if(alreadyUploadedName(f.name)){ toast(`Skipped (already uploaded by name): ${f.name}`,'info'); continue; }
    const hash = await sha256(f);
    if(alreadyUploadedHash(hash)){ toast(`Skipped (already uploaded by hash): ${f.name}`,'info'); continue; }

    const row = makeRow(f.name, f.size); q.appendChild(row);
    await uploadOne(f, row);
  }
}

async function uploadOne(file, row){
  const comments = document.getElementById('comments').value;
  controller = new AbortController();
  document.getElementById('cancelBtn').disabled = false;

  // live speed
  let uploaded = 0; const started = Date.now();
  const origFetch = window.fetch;
  // monkey-patch fetch body to track progress using ReadableStream
  const stream = file.stream();
  const reader = stream.getReader();

  const rs = new ReadableStream({
    async pull(ctrl){
      const {value, done} = await reader.read();
      if(done){ ctrl.close(); return; }
      uploaded += value.length;
      const dt = (Date.now()-started)/1000; const speed = uploaded/dt;
      row.querySelector('[data-speed]').textContent = `Speed: ${fmtBytes(speed)}/s`;
      const pct = Math.min(100, (uploaded/file.size)*100);
      row.querySelector('.progress > div').style.width = pct.toFixed(1)+'%';
      ctrl.enqueue(value);
    }
  });

  const form = new FormData();
  form.append('comments', comments);
  // Use transformed stream as a Blob
  const streamedFile = new File([rs], file.name, { type: file.type });
  form.append('files', streamedFile, file.name);

  try{
    const r = await fetch('/api/upload', { method:'POST', body: form, signal: controller.signal });
    if(!r.ok){ throw new Error(await r.text()); }
    const j = await r.json();
    const id = j.saved[0].id;
    rememberDoneName(file.name);

    // now make link
    const gl = await post('/api/getlink', { id });
    rememberDoneHash(await sha256(file));
    const a = row.querySelector('[data-link]'); const btn = row.querySelector('[data-copy]');
    a.href = gl.directUrl; a.style.display='inline-block'; a.textContent='Open';
    btn.style.display='inline-block';
    btn.onclick = async ()=>{ await navigator.clipboard.writeText(gl.directUrl); toast('Link copied','success'); };
    toast('Uploaded','success');
  }catch(e){
    if(e.name==='AbortError'){ toast('Upload cancelled','info'); }
    else { toast('Upload failed','error'); }
  }finally{
    controller = null; document.getElementById('cancelBtn').disabled = true;
  }
}

function cancelUpload(){
  if(controller){ controller.abort(); toast('Cancelled','info'); }
}
</script>
</body></html>
